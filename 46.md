NIP-46
======

Nostrコネクト
------------------------

`draft` `optional` `author:tiero` `author:giowe` `author:vforvalerio87`

## 動機

秘密鍵は、アプリ、OS、デバイスなど攻撃表面を増加させるシステムからできる限り隠す必要が有ります。

秘密鍵の入力も悩みの種であり、悪意のあるソフトに監視される可能性のあるOSのクリップボードなど多くのシステムに秘密鍵を晒す事になります。


## 用語の説明

* **クライアント**: クライアントの代わりに行動してもらうことを*要求する*任意のプラットフォームのNostrクライアント
* **署名アプリ**: Nostrアカウントの秘密鍵を持ち、クライアントの代わりに*署名を行う*Nostrアプリ


## 要約 (`TL;DR`)

 
**クライアント**と**署名アプリ**は選択したリレーを使用してkind `24133`で一時的な暗号化されたメッセージを送り合います。

クライアントは公開鍵の取得やイベントへの署名を行うよう署名アプリに求めます。

`content`フィールドは暗号化されたJSONRPC風の**要求**または**応答**でなければなりません。

## 署名アプリのプロトコル

### メッセージ

#### 要求

```json
{
  "id": <random_string>,
  "method": <one_of_the_methods>,
  "params": [<anything>, <else>]
}
```

#### 応答

```json
{
  "id": <request_id>,
  "result": <anything>,
  "error": <reason>
}
```

### メソッド


#### 必須

以下に示すものは、リモート署名アプリが実装しなければならない必須のメソッドです。 (MUST)

- **describe**
  - 引数 []
  - 結果 `["describe", "get_public_key", "sign_event", "connect", "disconnect", "delegate", ...]`  
- **get_public_key**
  - 引数 []
  - 結果 `pubkey` 
- **sign_event**
  - 引数 [`event`]
  - 結果 `event_with_signature` 

#### 任意


- **connect**
  - 引数 [`pubkey`]
- **disconnect**
  - 引数 []
- **delegate** 
  - 引数 [`delegatee`, `{ kind: number, since: number, until: number }`]
  - 結果 `{ from: string, to: string, cond: string, sig: string }`
- **get_relays**
  - 引数 []
  - 結果 `{ [url: string]: {read: boolean, write: boolean} }` 
- **nip04_encrypt**
  - 引数 [`pubkey`, `plaintext`]
  - 結果 `nip4 ciphertext`
- **nip04_decrypt**
  - 引数 [`pubkey`, `nip4 ciphertext`]
  - 結果 [`plaintext`]


注意: `pubkey`と`signature`は16進数エンコードされた文字列です。


### NostrコネクトURI

**署名アプリ**はQRコードの読み取り、ディープリンクのクリック、URIのコピーアンドペーストによって**クライアント**を発見します。

**クライアント**は`nostrconnect://`で始まり、ベースパスに16進数でエンコードされた`pubkey`を持ち、URLエンコードされた以下のクエリ文字列を含む専用のURIを生成します。

- `relay`**クライアント**が接続され、**署名アプリ**がメッセージを送受信しなければならないリレーのURL。
- `metadata`**クライアント**のメタデータを持つJSON
    - `name`人間が読める形式の**クライアント**の名前。
    - `url`(任意) 接続を要求しているwebサイトのURL。
    - 'description`(任意) **クライアント**の説明。
    - `icons`(任意) **クライアント**のアイコンのURLの配列。

#### JavaScript

```js
const uri = `nostrconnect://<pubkey>?relay=${encodeURIComponent("wss://relay.damus.io")}&metadata=${encodeURIComponent(JSON.stringify({"name": "Example"}))}`
```

#### 例
```sh
nostrconnect://b889ff5b1513b641e2a139f661a661364979c5beee91842f8f0ef42ab558e9d4?relay=wss%3A%2F%2Frelay.damus.io&metadata=%7B%22name%22%3A%22Example%22%7D
```



## Nostrコネクトの流れ

`content`フィールドは`kind``24133`を用い、[NIP04](https://github.com/nostr-protocol/nips/blob/master/04.md)で指定された方法で暗号化されたメッセージです。

### 接続

1. ユーザーがwebサイトの**接続**ボタンを押すかQRコードを読み取ります。
2. 「Nostrコネクト」  に対応した**署名アプリ**を開くURIを表示します。
3. そのURIにはこのように**クライアント**の公開鍵が含まれています。 `nostrconnect://<pubkey>&relay=<relay>&metadata=<metadata>` 
4.**署名アプリ**は自身の公開鍵で`connect`要求に対する確認応答を行います。

### 切断 (クライアントから)

1. ユーザーが**クライアント**の**切断**ボタンをクリックします。
2. **クライアント**は**署名アプリ**に`disconnect`要求を送信します。
3. **署名アプリ**は`disconnect`要求に対する確認応答を行います。 

### 切断 (署名アプリから)

1. ユーザーが**署名アプリ**の**切断** ボタンをクリックします。
2. **署名アプリ**は**クライアント**に`diaconnect`要求を行います。


### 公開鍵の取得

1. **クライアント**は**署名アプリに**`get_public_key`リクエストを行います。
3. **署名アプリ**は`get_public_key`要求への応答として公開鍵を返します。

### イベントの署名

1. **クライアント**は**署名アプリ**に署名したいイベントと共に`sign_event`要求を行います。
2. **署名アプリ** はユーザーにイベントの内容を検査して署名するためのポップアップを表示します。
3. **署名アプリ**は`sign_event`要求への応答として`id`とシュノア`signature`を含むイベントメッセージを返します。

### 委譲

1. **クライアント**は**署名アプリ**にクエリ文字列の条件句と共に`delegate`要求を行います。
2. **署名アプリ**はユーザーに対して**クライアント**に署名を委譲して、代わりに署名を行なってもらうためのポップアップを表示します。
3. **署名アプリ**は署名付きの[NIP-26委譲トークン](https://github.com/nostr-protocol/nips/blob/master/26.md)を送り返すか、以上を却下する。 (訳注: 委譲トークンは委譲文字列のSHA256ハッシュへの署名である為、原文が誤りであると考えられます。そのうちにPRを送ります。)

